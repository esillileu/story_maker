# 📘 분기형 동적 서사 생성기

> 사용자 선택과 상호작용에 따라 세계관 내 분기 서사를 동적으로 생성하는 시스템.  
> 서사는 사건 리스트로 구성되며, 사건은 서사 상태(플래그)를 변화시킨다.  
> 플래그는 서사 진행의 맥락을 구성하고 다음 상황에 영향을 준다.

---

## 1. 핵심 개념

- **상황**: 사용자에게 제시되는 시공간적 맥락.
- **반응**: 사용자 행동에 대한 시스템의 서술 및 대사.
- **사건**: 상황-반응-결과-의도로 구성된 서사의 단위.
- **서사**: 사건들의 시퀀스. 분기마다 새로운 서사 생성.
- **플래그**: 서사 상태를 나타내는 구조화된 키. 재사용 가능.
- **회귀**: 과거 사건에서 새로운 서사를 생성해 분기.

---

## 2. 설계 철학

- 게으른 생성: 직접 접근하지 않은 정보는 생성하지 않음.
- 동적 주기: 흐름에 따라 저장 시점 유동 결정.
- 상태 중심 진행: 사건 발생 시 서사 상태(플래그) 변경.
- 반의도성 부여: 예측을 벗어나되 몰입은 유지.
- 회귀 기반 분기: 사건 시점부터 새 서사 생성.

---

## 3. 시스템 흐름

```
상황 생성기 → 사용자 입력  
→ 의도 추론기 → 반응기 → 대사 생성 → 적합성 확인  
→ 사건 종료 판단  
→ 사건 요약기 + 정보 추출기 + 플래그 생성기  
→ 상태 저장 + 플래그 저장  
→ 서사 요약기 → 다음 상황 생성기로 루프
```

---

## 4. 회귀 및 분기

- 기존 서사의 특정 사건까지 복사해 새로운 서사 생성.
- 새로운 서사에 timeline_id 부여.
- 기존 플래그는 분기 시점 이전까지 복사.

---

## 5. 데이터 분류

| 분류 | 유형 |
|------|------|
| 불변 정보 | 세계관 설정, 캐릭터 기본 정보 |
| 가변 정보 | 캐릭터 상태, 관계, 지식, 세계관 상태, 플래그 |

---

## 6. 컴포넌트 목록

### 6.1 서사 관리

- **상황 생성기**  
  서사와 현재 플래그 기반으로 다음 상황 서술 생성.  
  세계관/인물 맥락 일관성 유지.

- **의도 추론기**  
  사용자 입력에서 목적·감정·의도를 추출.  
  행동 반응기와 플래그 생성기 입력으로 사용.

- **사건 요약기**  
  상황-반응-결과-의도를 구조화.  
  회귀·서사 요약·정보 추출의 기준 정보 생성.

- **플래그 관리기**  
  사건 결과로 추출된 서사 상태를 플래그로 표현.  
  중복 방지, 의미 기반 ID 관리, 플래그 목록 등록 및 변경 처리.

- **서사 요약기**  
  플래그/상태/주제 흐름을 기반으로 요약.  
  다음 상황 생성기와 회귀 시점 판단에 사용.

- **사건 종료 판단기**  
  반응 반복성, 흐름 정체, 명시 조건 등을 근거로 사건 종료 결정.

---

### 6.2 정보 관리

- **정보 추출기**  
  사건 종료 시 지식, 상태, 관계 변화 수집.  
  event_id 기준으로 시점 추적 가능.

- **기억 통제기**  
  캐릭터별 알고 있는 정보, 회귀 후 기억 유지 여부 제어.

- **정합성 검증기**  
  새로 생성된 사건이나 상태의 설정 위반 여부 검토.

- **DB 연동 모듈**  
  events, characters, relations, flags, knowledge 등 저장 및 질의 처리.

---

### 6.3 대화 관리

- **행동 반응기**  
  입력된 행동과 해석된 의도를 기반으로 소설 형식의 서술과 캐릭터 대사 생성.  
  페르소나, 기억 상태, 플래그 영향을 반영.

- **페르소나**  
  캐릭터의 말투, 시점, 감정적 어조를 지정.

- **적합성 매니저**  
  캐릭터 반응이 상황, 설정, 세계관에 부합하는지 검토.

- **기억 매니저**  
  개별 캐릭터가 알고 있는 사실과 감정 이력 관리.

---

## 7. 서사 흐름 예시

```plaintext
[상황 제시]
  어둠 속, 귀족 카이엘이 리에나를 노려본다. 그의 손에는 반란의 증거가 들려 있다.

[사용자 입력]
  나는 조용히 칼자루에 손을 얹었다.

[의도 추론기]
  → "위협", "반응 유도"로 해석

[행동 반응기 출력]
  카이엘의 눈이 가늘게 좁아졌다.  
  "그 검을 꺼내면, 다시는 넣지 못할 줄 알라."

[플래그 생성]
  - `kai_scorns_riena`: 카이엘은 리에나를 조롱했다

[사건 요약]
  상황: 반란 증거를 든 카이엘  
  반응: 리에나의 무언의 도발  
  결과: 긴장 고조  
  의도: 위협
```
